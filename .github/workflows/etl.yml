name: Daily ETL (Stormglass → history.csv → site/data.json)

on:
  schedule:
    # 19:00 UTC = 02:00 Asia/Ho_Chi_Minh (ngày kế tiếp)
    - cron: "0 19 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  run-etl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r etl/requirements.txt

      - name: Run ETL
        env:
          STORMGLASS_KEY_1: ${{ secrets.STORMGLASS_KEY_1 }}
          STORMGLASS_KEY_2: ${{ secrets.STORMGLASS_KEY_2 }}
          STORMGLASS_KEY_3: ${{ secrets.STORMGLASS_KEY_3 }}
        run: |
          python etl/fetch_and_merge.py

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [[ -n "$(git status --porcelain)" ]]; then
            git add data/history.csv site/data.json
            git commit -m "ETL: update $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          else
            echo "No changes"
          fi
